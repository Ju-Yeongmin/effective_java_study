# Item 76
## 가능한 한 실패 원자적으로 만들어라

#### 실패 원자성
실패 원자성이란 호출된 메서드가 실패해도 해당 객체가 메서드 호출 전의 상태를 유지하는 것을 말한다
- 작업 도중 예외가 발생해도 그 객체를 정상적으로 사용할 수 있는 것

### 메서드를 실패 원자성으로 만드는 방법
#### 1. 불변 객체로 설계하라
- 불변 객체는 태생적으로 실패 원자적이다
- 불변 객체의 상태는 생성 시점에 고정되어서 절대 변하지 않기 때문
- 메서드가 실패해도 기존 객체가 불안정한 상태에 빠지는 일은 결코 없다

#### 2. 가변 객체라면?
1) 가변 객체를 실패 원자적으로 만드는 가장 쉬운 방법은 수행전 매개변수의 유효성을 체크
2) 실패할 가능성이 있는 모든 코드를 객체의 상태를 바꾸는 코드보다 앞에 배치


```java
public Object pop() {
  if (element.length() == 0) {
    throw new EmptyStackException();
  }
  Object result = elements[1]
  return result;
}
```

#### 3. 객체의 임시 복사본에서 작업을 수행한 후 성공하면 원본 객체와 교체
데이터를 임시 자료구조에 저장해 작업하는게 더 빠르다면 적용하기 좋은 방식
- 예를들어 정렬을 수행하기 전 정렬할 리스트의 원소들을 배열로 옮겨담고,
- 옮겨담은 배열에서 정렬을 수행한 후 원래 배열과 변경
- 이렇게하면 실패하더라도 원본 리스트의 상태는 변하지 않는다

#### 4.작업 도중 발생하는 실패를 가로채는 복구 코드를 작성하여 작업 전 상태로 돌리기
자주 쓰이는 방법은 아니라고 한다
- 주로 디스크 기반의 내구성을 보장해야 하는 자료구조에 사용

#### 실패 원자성은 항상 달성할 수 있는것은 아니다
일반적으로 실패 원자성은 권장되는 덕목이지만 항상 달성할 수 있는 것은 아니다
- 멀티 스레드 환경의 경우 동기화 없이 같은 객체를 동시에 수정한다면 일관성이 깨질 수 있다

#### 실패 원자적으로 만들 수 있어도 항상 해야하는 것도 아니다
실패 원자성을 달성하기 위한 비용이나 복잡도가 더 커지는 연산도 존재한다


```java
핵심!
메서드에서 예외가 발생하더라도 객체의 상태는 메서드 호출전과 똑같이 유지되어야 하는 것이
기본 규칙이다. 이 규칙을 지키지 못한다면 실패했을 때 객체 상태를 API에 명시해야 한다.
그렇지만 무조건 실패 원자성으로 만들 수 있는 것은 아니므로 유연한 대처가 필요하다
```

